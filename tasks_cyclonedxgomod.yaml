version: 3

includes:
  tools:
    taskfile: tasks_tools.yaml
    internal: true

tasks:
  # This is a dummy task that serves as a separator between task namespaces in the 'task -l' output.
  "---":
    desc: "{{.CYCLONEDXGOMOD_SEP}}"
    cmds:
    - cmd: echo "{{.SEP_MSG}}"
      silent: true

  mod-application:
    desc: "  Build the SBOM considering the go.mod."
    run: once
    deps:
      - tools:cyclonedxgomod
    cmds:
      - 'cd {{.ROOT_DIR2}}; {{.CYCLONEDXGOMOD}} mod -licenses -output sbom.json'

  mod-library:
    desc: "  Build the SBOM considering the go.mod."
    run: once
    deps:
      - tools:cyclonedxgomod
    cmds:
      - 'cd {{.ROOT_DIR2}}; {{.CYCLONEDXGOMOD}} mod -type library -licenses -output sbom.json'
      -
  app:
    desc: '  Build the SBOM for each component'
    run: once
    cmds:
      - for:
          var: COMPONENTS
        vars:
          COMPONENT: '{{.ITEM}}'
        task: app-internal

  app-internal:
    desc: " Build the SBOM for a specific component."
    run: when_changed
    deps:
      - tools:cyclonedxgomod
    requires:
      vars:
        - COMPONENT
    cmds:
      - 'cd {{.ROOT_DIR2}}; "{{.CYCLONEDXGOMOD}}" app -json -output {{.COMPONENT}}-app.sbom.json -packages -files -licenses -main ./cmd/{{.COMPONENT}} {{.ROOT_DIR2}}'
    internal: true
